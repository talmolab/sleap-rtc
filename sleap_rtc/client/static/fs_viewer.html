<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLEAP-RTC File Browser</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-hover: #22222e;
            --border-color: #2a2a3a;
            --border-highlight: #3d3d52;
            --text-primary: #e8e8f0;
            --text-secondary: #9090a8;
            --text-muted: #606078;
            --accent-primary: #6366f1;
            --accent-secondary: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.15);
            --warning: #f59e0b;
            --error: #ef4444;
            --folder-color: #fbbf24;
            --file-slp: #a78bfa;
            --file-video: #38bdf8;
            --file-model: #f472b6;
            --file-default: #9090a8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            font-weight: 600;
            font-size: 1.25rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .connection-badge.connected {
            background: var(--success-glow);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .connection-badge.connected::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connection-badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error);
        }

        .connection-badge.disconnected::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
        }

        .connection-badge.connecting {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--warning);
        }

        .connection-badge.connecting::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .worker-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 4px;
        }

        .view-toggle-btn {
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-toggle-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .view-toggle-btn.active {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-secondary);
        }

        .view-toggle-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Main layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .mount-points {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .mount-point {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.875rem;
        }

        .mount-point:hover {
            background: var(--bg-hover);
        }

        .mount-point.active {
            background: var(--accent-glow);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .mount-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .mount-name {
            font-weight: 500;
        }

        .mount-path {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: auto;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Content panel */
        .content-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
            height: 100%;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            overflow-x: auto;
        }

        .breadcrumb-item {
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.15s ease;
            white-space: nowrap;
        }

        .breadcrumb-item:hover {
            color: var(--accent-secondary);
        }

        .breadcrumb-item.current {
            color: var(--text-primary);
            font-weight: 500;
        }

        .breadcrumb-sep {
            color: var(--text-muted);
        }

        /* File grid */
        .file-grid {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .grid-title {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .grid-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .grid-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.25rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .grid-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-highlight);
            transform: translateY(-2px);
        }

        .grid-item.selected {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
        }

        .grid-item-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 0.75rem;
        }

        .grid-item-name {
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            word-break: break-all;
            margin-bottom: 0.25rem;
        }

        .grid-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Action bar */
        .action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .selected-path {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
            min-width: 0;
        }

        .selected-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .selected-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-highlight);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading states */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.75rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .empty-desc {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Error state */
        .error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            color: var(--error);
            margin-bottom: 1rem;
        }

        .error-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--error);
            margin-bottom: 0.5rem;
        }

        .error-desc {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            border: 1px solid var(--success);
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 2000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            color: var(--success);
        }

        /* Pagination indicator */
        .pagination-info {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 1rem;
            text-align: center;
        }

        .load-more-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .load-more-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px 0;
            min-width: 180px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: background 0.1s ease;
        }

        .context-menu-item:hover {
            background: var(--bg-hover);
        }

        .context-menu-item svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* Column view */
        .column-container {
            display: flex;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            background: var(--bg-primary);
        }

        .column-wrapper {
            display: flex;
            flex-shrink: 0;
        }

        .column {
            width: 220px;
            min-width: 120px;
            max-width: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .column-resize-handle {
            width: 4px;
            cursor: col-resize;
            background: var(--border-color);
            transition: background 0.15s ease;
            flex-shrink: 0;
        }

        .column-resize-handle:hover,
        .column-resize-handle.dragging {
            background: var(--accent-primary);
        }

        .column-header {
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .column-items {
            flex: 1;
            overflow-y: auto;
        }

        .column-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: background 0.1s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .column-item:last-child {
            border-bottom: none;
        }

        .column-item:hover {
            background: var(--bg-hover);
        }

        .column-item.selected {
            background: var(--accent-glow);
        }

        .column-item-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .column-item-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .column-item-chevron {
            margin-left: auto;
            opacity: 0.4;
            flex-shrink: 0;
        }

        .column-item-chevron svg {
            width: 12px;
            height: 12px;
        }

        .column-load-more {
            padding: 8px 12px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            border-top: 1px solid var(--border-color);
        }

        .column-load-more:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        /* File detail column */
        .file-detail-column {
            width: 280px;
            min-width: 280px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
        }

        .file-detail-icon {
            width: 64px;
            height: 64px;
        }

        .file-detail-name {
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            word-break: break-all;
        }

        .file-detail-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .file-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8125rem;
        }

        .file-detail-label {
            color: var(--text-muted);
        }

        .file-detail-value {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">SLEAP-RTC File Browser</div>
            <div class="connection-badge connecting" id="connectionBadge">
                <span id="connectionStatus">Connecting...</span>
            </div>
        </div>
        <div class="view-toggle">
            <button class="view-toggle-btn active" id="iconViewBtn" onclick="setViewMode('icon')" title="Icon View">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                </svg>
            </button>
            <button class="view-toggle-btn" id="columnViewBtn" onclick="setViewMode('column')" title="Column View">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="5" height="18" rx="1"/>
                    <rect x="10" y="3" width="5" height="18" rx="1"/>
                    <rect x="17" y="3" width="5" height="18" rx="1"/>
                </svg>
            </button>
        </div>
        <div class="worker-info" id="workerInfo">
            Worker: -
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Mount Points</div>
                <div class="mount-points" id="mountPoints">
                    <div class="loading"><div class="spinner"></div>Loading...</div>
                </div>
            </div>
        </aside>

        <!-- Content Panel -->
        <main class="content-panel">
            <!-- Breadcrumb -->
            <nav class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item current">Select a mount point</span>
            </nav>

            <!-- File Grid -->
            <div class="file-grid" id="fileGrid">
                <div class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <div class="empty-title">Select a Mount Point</div>
                    <div class="empty-desc">Choose a mount point from the sidebar to browse files.</div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="selected-path">
                    <span class="selected-label">Selected:</span>
                    <div class="selected-value" id="selectedPath">No path selected</div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                    <button class="btn btn-primary" id="copyPathBtn" disabled onclick="copyPath()">Copy Path</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <span id="toastMessage">Path copied to clipboard</span>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuOpen()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
            </svg>
            <span>Open Folder</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuCopyPath()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
            <span>Copy Folder Path</span>
        </div>
        <div class="context-menu-item" onclick="contextMenuSelect()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span>Select Folder</span>
        </div>
    </div>

    <script>
        // State
        let ws = null;
        let currentPath = '';
        let selectedFile = null;
        let mounts = [];
        let workerInfo = null;
        let currentEntries = [];
        let totalCount = 0;
        let hasMore = false;

        // View mode state
        let viewMode = localStorage.getItem('sleap-rtc-view-mode') || 'icon';

        // Column view state
        let columns = []; // Array of {path, entries, selectedIndex, hasMore, totalCount}

        // Context menu state
        let contextMenuPath = null;

        // Get token from URL
        function getToken() {
            const params = new URLSearchParams(window.location.search);
            return params.get('token');
        }

        // Utility functions
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
        }

        function getFileColor(ext) {
            switch(ext) {
                case 'slp': return 'file-slp';
                case 'mp4': case 'avi': case 'mov': return 'file-video';
                case 'h5': case 'keras': case 'pt': case 'onnx': return 'file-model';
                default: return 'file-default';
            }
        }

        function getExtension(filename) {
            const parts = filename.split('.');
            return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : '';
        }

        function getGridIcon(type, ext) {
            if (type === 'directory') {
                return `<svg class="grid-item-icon" style="color: var(--folder-color)" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                </svg>`;
            }

            const color = getFileColor(ext);
            if (ext === 'slp') {
                return `<svg class="grid-item-icon" style="color: var(--file-slp)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <circle cx="12" cy="14" r="3"/>
                </svg>`;
            }
            if (ext === 'mp4' || ext === 'avi' || ext === 'mov') {
                return `<svg class="grid-item-icon" style="color: var(--file-video)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                    <polygon points="10 9 16 12 10 15"/>
                </svg>`;
            }
            if (['h5', 'keras', 'pt', 'onnx'].includes(ext)) {
                return `<svg class="grid-item-icon" style="color: var(--file-model)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>`;
            }
            return `<svg class="grid-item-icon" style="color: var(--file-default)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>`;
        }

        function getColumnIcon(type, ext) {
            if (type === 'directory') {
                return `<svg class="column-item-icon" style="color: var(--folder-color)" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                </svg>`;
            }
            const color = getFileColor(ext);
            return `<svg class="column-item-icon" style="color: var(--${color})" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>`;
        }

        function getDetailIcon(type, ext) {
            if (type === 'directory') {
                return `<svg class="file-detail-icon" style="color: var(--folder-color)" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>
                </svg>`;
            }
            const color = getFileColor(ext);
            return `<svg class="file-detail-icon" style="color: var(--${color})" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>`;
        }

        // View mode functions
        function setViewMode(mode) {
            viewMode = mode;
            localStorage.setItem('sleap-rtc-view-mode', mode);

            // Update toggle buttons
            document.getElementById('iconViewBtn').classList.toggle('active', mode === 'icon');
            document.getElementById('columnViewBtn').classList.toggle('active', mode === 'column');

            // Show/hide breadcrumb based on view mode
            document.getElementById('breadcrumb').style.display = mode === 'icon' ? 'flex' : 'none';

            // Re-render current view
            if (currentPath) {
                if (mode === 'icon') {
                    renderFileGrid();
                    renderBreadcrumb();
                } else {
                    // Reset columns and load from current path
                    columns = [];
                    requestColumnDir(currentPath, 0);
                }
            }
        }

        function initViewMode() {
            document.getElementById('iconViewBtn').classList.toggle('active', viewMode === 'icon');
            document.getElementById('columnViewBtn').classList.toggle('active', viewMode === 'column');
            // Hide breadcrumb initially if in column mode
            document.getElementById('breadcrumb').style.display = viewMode === 'icon' ? 'flex' : 'none';
        }

        // Context menu functions
        function showContextMenu(e, path) {
            e.preventDefault();
            contextMenuPath = path;

            const menu = document.getElementById('contextMenu');
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
            contextMenuPath = null;
        }

        function contextMenuOpen() {
            if (contextMenuPath) {
                navigateTo(contextMenuPath);
            }
            hideContextMenu();
        }

        function contextMenuCopyPath() {
            if (contextMenuPath) {
                navigator.clipboard.writeText(contextMenuPath).then(() => {
                    showToast('Folder path copied to clipboard');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy path');
                });
            }
            hideContextMenu();
        }

        function contextMenuSelect() {
            if (contextMenuPath) {
                selectedFile = contextMenuPath;
                if (viewMode === 'icon') {
                    renderFileGrid();
                } else {
                    renderColumnView();
                }
                updateSelectedPath();
            }
            hideContextMenu();
        }

        // Close context menu on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                hideContextMenu();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideContextMenu();
            }
        });

        // Column resize functions
        let resizingColumnIndex = null;
        let resizeStartX = 0;
        let resizeStartWidth = 0;

        function startColumnResize(e, colIndex) {
            e.preventDefault();
            resizingColumnIndex = colIndex;
            resizeStartX = e.clientX;
            resizeStartWidth = columns[colIndex].width || 220;

            // Add dragging class
            e.target.classList.add('dragging');

            // Add global listeners
            document.addEventListener('mousemove', handleColumnResize);
            document.addEventListener('mouseup', stopColumnResize);

            // Prevent text selection while dragging
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'col-resize';
        }

        function handleColumnResize(e) {
            if (resizingColumnIndex === null) return;

            const delta = e.clientX - resizeStartX;
            let newWidth = resizeStartWidth + delta;

            // Clamp to min/max
            newWidth = Math.max(120, Math.min(400, newWidth));

            // Update column width
            columns[resizingColumnIndex].width = newWidth;

            // Update DOM directly for smooth resize
            const column = document.querySelector(`.column[data-col-index="${resizingColumnIndex}"]`);
            if (column) {
                column.style.width = newWidth + 'px';
            }
        }

        function stopColumnResize(e) {
            if (resizingColumnIndex !== null) {
                // Remove dragging class
                const handle = document.querySelector(`.column-resize-handle[data-col-index="${resizingColumnIndex}"]`);
                if (handle) {
                    handle.classList.remove('dragging');
                }
            }

            resizingColumnIndex = null;

            // Remove global listeners
            document.removeEventListener('mousemove', handleColumnResize);
            document.removeEventListener('mouseup', stopColumnResize);

            // Restore cursor
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
        }

        // WebSocket connection
        function connectWebSocket() {
            const token = getToken();
            if (!token) {
                showError('Missing authentication token');
                return;
            }

            const wsUrl = `ws://localhost:${window.location.port}/ws?token=${token}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                updateConnectionStatus('connected', 'Connected');
            };

            ws.onclose = () => {
                updateConnectionStatus('disconnected', 'Disconnected');
                // Try to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateConnectionStatus('disconnected', 'Connection Error');
            };

            ws.onmessage = (event) => {
                handleMessage(JSON.parse(event.data));
            };
        }

        function updateConnectionStatus(status, text) {
            const badge = document.getElementById('connectionBadge');
            const statusText = document.getElementById('connectionStatus');

            badge.className = 'connection-badge ' + status;
            statusText.textContent = text;
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'worker_info':
                    workerInfo = msg.data;
                    document.getElementById('workerInfo').textContent =
                        `Worker: ${workerInfo.worker_id}`;
                    break;

                case 'mounts':
                    mounts = msg.data;
                    renderMountPoints();
                    break;

                case 'list_response':
                    const entries = msg.data.entries || [];
                    const total = msg.data.total_count || 0;
                    const more = msg.data.has_more || false;
                    const path = msg.data.path || currentPath;
                    const colIndex = msg.data.column_index;
                    const append = msg.data.append;

                    if (viewMode === 'column' && colIndex !== undefined) {
                        // Column view response
                        if (append && columns[colIndex]) {
                            // Append to existing column
                            columns[colIndex].entries = columns[colIndex].entries.concat(entries);
                            columns[colIndex].hasMore = more;
                            columns[colIndex].totalCount = total;
                        } else {
                            // New column or replace
                            columns[colIndex] = {
                                path: path,
                                entries: entries,
                                selectedIndex: null,
                                hasMore: more,
                                totalCount: total
                            };
                            // Trim any columns after this one
                            columns = columns.slice(0, colIndex + 1);
                        }
                        currentPath = path;
                        renderColumnView();
                        renderMountPoints();
                    } else {
                        // Icon view response
                        if (append) {
                            currentEntries = currentEntries.concat(entries);
                        } else {
                            currentEntries = entries;
                        }
                        totalCount = total;
                        hasMore = more;
                        renderFileGrid();
                    }
                    break;

                case 'error':
                    showError(`${msg.code}: ${msg.message}`);
                    break;

                case 'connection_lost':
                    updateConnectionStatus('disconnected', 'Worker Disconnected');
                    showError('Worker connection lost');
                    break;
            }
        }

        function showError(message) {
            const container = document.getElementById('fileGrid');
            container.innerHTML = `
                <div class="error-state">
                    <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="12"/>
                        <line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <div class="error-title">Error</div>
                    <div class="error-desc">${message}</div>
                </div>
            `;
        }

        // Render mount points
        function renderMountPoints() {
            const container = document.getElementById('mountPoints');

            if (mounts.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-desc">No mount points configured</div></div>';
                return;
            }

            container.innerHTML = mounts.map(mount => {
                const isActive = currentPath.startsWith(mount.path);
                return `
                    <div class="mount-point ${isActive ? 'active' : ''}" onclick="selectMount('${mount.path}')">
                        <svg class="mount-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"/>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                        </svg>
                        <span class="mount-name">${mount.label}</span>
                        <span class="mount-path">${mount.path}</span>
                    </div>
                `;
            }).join('');
        }

        // Render breadcrumb
        function renderBreadcrumb() {
            const container = document.getElementById('breadcrumb');

            if (!currentPath) {
                container.innerHTML = '<span class="breadcrumb-item current">Select a mount point</span>';
                return;
            }

            const parts = currentPath.split('/').filter(p => p);
            let html = '';
            let accPath = '';

            parts.forEach((part, i) => {
                accPath += '/' + part;
                const isLast = i === parts.length - 1;
                if (i > 0) html += '<span class="breadcrumb-sep">/</span>';
                html += `<span class="breadcrumb-item ${isLast ? 'current' : ''}" onclick="navigateTo('${accPath}')">${part}</span>`;
            });

            container.innerHTML = html;
        }

        // Render file grid
        function renderFileGrid() {
            const container = document.getElementById('fileGrid');

            if (currentEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <div class="empty-title">Empty Directory</div>
                        <div class="empty-desc">This folder contains no files or subdirectories.</div>
                    </div>
                `;
                return;
            }

            const dirCount = currentEntries.filter(e => e.type === 'directory').length;
            const fileCount = currentEntries.length - dirCount;

            const gridItems = currentEntries.map(entry => {
                const itemPath = currentPath + '/' + entry.name;
                const isSelected = selectedFile === itemPath;
                const ext = getExtension(entry.name);
                const contextMenuAttr = entry.type === 'directory' ? `oncontextmenu="showContextMenu(event, '${itemPath}')"` : '';

                return `
                    <div class="grid-item ${isSelected ? 'selected' : ''}"
                         onclick="${entry.type === 'directory' ? `navigateTo('${itemPath}')` : `selectFile('${itemPath}')`}"
                         ondblclick="${entry.type === 'directory' ? `navigateTo('${itemPath}')` : `copyPath()`}"
                         ${contextMenuAttr}>
                        ${getGridIcon(entry.type, ext)}
                        <div class="grid-item-name">${entry.name}</div>
                        <div class="grid-item-meta">${entry.type === 'directory' ? 'Folder' : formatSize(entry.size || 0)}</div>
                    </div>
                `;
            }).join('');

            let paginationHtml = '';
            if (hasMore) {
                paginationHtml = `
                    <div class="pagination-info">
                        Showing ${currentEntries.length} of ${totalCount} items
                        <br>
                        <button class="load-more-btn" onclick="loadMore()">Load More</button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="grid-header">
                    <div class="grid-title">Contents</div>
                    <div class="grid-count">${dirCount} folders, ${fileCount} files</div>
                </div>
                <div class="grid-container">
                    ${gridItems}
                </div>
                ${paginationHtml}
            `;
        }

        // Render column view
        function renderColumnView() {
            const container = document.getElementById('fileGrid');

            if (columns.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        <div class="empty-title">Select a Mount Point</div>
                        <div class="empty-desc">Choose a mount point from the sidebar to browse files.</div>
                    </div>
                `;
                return;
            }

            let columnsHtml = columns.map((col, colIndex) => {
                const pathParts = col.path.split('/').filter(p => p);
                const columnName = pathParts[pathParts.length - 1] || 'Root';
                const columnWidth = col.width || 220;

                const itemsHtml = col.entries.map((entry, entryIndex) => {
                    const itemPath = col.path + '/' + entry.name;
                    const isSelected = col.selectedIndex === entryIndex;
                    const ext = getExtension(entry.name);
                    const contextMenuAttr = entry.type === 'directory' ? `oncontextmenu="showContextMenu(event, '${itemPath}')"` : '';

                    return `
                        <div class="column-item ${isSelected ? 'selected' : ''}"
                             onclick="columnItemClick(${colIndex}, ${entryIndex}, '${itemPath}', '${entry.type}')"
                             ${contextMenuAttr}>
                            ${getColumnIcon(entry.type, ext)}
                            <span class="column-item-name">${entry.name}</span>
                            ${entry.type === 'directory' ? `
                                <span class="column-item-chevron">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 18 15 12 9 6"/>
                                    </svg>
                                </span>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                const loadMoreHtml = col.hasMore ? `
                    <div class="column-load-more" onclick="loadMoreColumn(${colIndex})">
                        Load more (${col.entries.length} of ${col.totalCount})
                    </div>
                ` : '';

                return `
                    <div class="column-wrapper">
                        <div class="column" data-col-index="${colIndex}" style="width: ${columnWidth}px;">
                            <div class="column-header">${columnName}</div>
                            <div class="column-items">
                                ${itemsHtml}
                            </div>
                            ${loadMoreHtml}
                        </div>
                        <div class="column-resize-handle" data-col-index="${colIndex}" onmousedown="startColumnResize(event, ${colIndex})"></div>
                    </div>
                `;
            }).join('');

            // Add file detail column if a file is selected
            const lastCol = columns[columns.length - 1];
            if (lastCol && lastCol.selectedIndex !== null) {
                const selectedEntry = lastCol.entries[lastCol.selectedIndex];
                if (selectedEntry && selectedEntry.type !== 'directory') {
                    const ext = getExtension(selectedEntry.name);
                    const itemPath = lastCol.path + '/' + selectedEntry.name;
                    columnsHtml += `
                        <div class="file-detail-column">
                            ${getDetailIcon(selectedEntry.type, ext)}
                            <div class="file-detail-name">${selectedEntry.name}</div>
                            <div class="file-detail-meta">
                                <div class="file-detail-row">
                                    <span class="file-detail-label">Size</span>
                                    <span class="file-detail-value">${formatSize(selectedEntry.size || 0)}</span>
                                </div>
                                <div class="file-detail-row">
                                    <span class="file-detail-label">Modified</span>
                                    <span class="file-detail-value">${selectedEntry.modified ? formatDate(selectedEntry.modified) : ''}</span>
                                </div>
                                <div class="file-detail-row">
                                    <span class="file-detail-label">Type</span>
                                    <span class="file-detail-value">${ext.toUpperCase() || 'File'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = `<div class="column-container">${columnsHtml}</div>`;

            // Scroll to the right to show newest column
            const columnContainer = container.querySelector('.column-container');
            if (columnContainer) {
                columnContainer.scrollLeft = columnContainer.scrollWidth;
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            if (isToday) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function columnItemClick(colIndex, entryIndex, itemPath, itemType) {
            // Update selection in this column
            columns[colIndex].selectedIndex = entryIndex;

            // Remove any columns after this one
            columns = columns.slice(0, colIndex + 1);

            if (itemType === 'directory') {
                // Add a new column for this directory
                selectedFile = null;
                requestColumnDir(itemPath, colIndex + 1);
            } else {
                // Select this file
                selectedFile = itemPath;
                renderColumnView();
                updateSelectedPath();
            }
        }

        function requestColumnDir(path, columnIndex) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'list_dir',
                    path: path,
                    offset: 0,
                    column_index: columnIndex
                }));
            }
        }

        function loadMoreColumn(colIndex) {
            const col = columns[colIndex];
            if (col && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'list_dir',
                    path: col.path,
                    offset: col.entries.length,
                    column_index: colIndex,
                    append: true
                }));
            }
        }

        // Event handlers
        function selectMount(path) {
            currentPath = path;
            selectedFile = null;
            currentEntries = [];
            columns = [];

            renderMountPoints();
            updateSelectedPath();

            if (viewMode === 'column') {
                // Show loading in column container
                document.getElementById('fileGrid').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
                requestColumnDir(path, 0);
            } else {
                renderBreadcrumb();
                requestListDir(path);
            }
        }

        function navigateTo(path) {
            currentPath = path;
            selectedFile = null;
            currentEntries = [];

            renderMountPoints();
            updateSelectedPath();

            // Show loading
            document.getElementById('fileGrid').innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            if (viewMode === 'column') {
                // In column view, navigateTo is called from context menu "Open Folder"
                // Reset columns and start fresh from this path
                columns = [];
                requestColumnDir(path, 0);
            } else {
                renderBreadcrumb();
                requestListDir(path);
            }
        }

        function selectFile(path) {
            selectedFile = path;
            renderFileGrid();
            updateSelectedPath();
        }

        function clearSelection() {
            selectedFile = null;
            if (viewMode === 'column') {
                // Clear selection in all columns
                columns.forEach(col => col.selectedIndex = null);
                renderColumnView();
            } else {
                renderFileGrid();
            }
            updateSelectedPath();
        }

        function updateSelectedPath() {
            const pathDisplay = document.getElementById('selectedPath');
            const copyBtn = document.getElementById('copyPathBtn');

            if (selectedFile) {
                pathDisplay.textContent = selectedFile;
                copyBtn.disabled = false;
            } else {
                pathDisplay.textContent = 'No path selected';
                copyBtn.disabled = true;
            }
        }

        function copyPath() {
            if (!selectedFile) return;

            navigator.clipboard.writeText(selectedFile).then(() => {
                showToast('Path copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy path');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function requestListDir(path, offset = 0, append = false) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'list_dir',
                    path: path,
                    offset: offset,
                    append: append
                }));
            }
        }

        function loadMore() {
            requestListDir(currentPath, currentEntries.length, true);
        }

        // Initialize
        initViewMode();
        connectWebSocket();
    </script>
</body>
</html>
